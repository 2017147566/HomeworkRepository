<!DOCTYPE html>
<html>

<head>
	<title>상품</title>
	<link rel="stylesheet" type="text/css" href="./main.css">
</head>
<body>
	<header>
		<div class="header-container">
			<h1>안녕하세요 마켓컬리입니다.</h1>
		</div>
        <div class="nav-container">
			<nav>
				<ul>
					<li><a href="./index.html">Home</a></li>
				</ul>
			</nav>
            <nav>
				<ul>
					<li><a href="./login.html">Login</a></li>
				</ul>
			</nav>
            <nav>
				<ul>
					<li><a href="./signup.html">Signup</a></li>
				</ul>
			</nav>
        </div>
	</header>
    <main>
        <div class="find">
            검색하기
            <input type="text" id = "search" class="searchInput" placeholder="검색하기">
            카테고리
            <select id = "category">
                <option value="">모두</option>
                <option value="mac">Mac</option>
                <option value="phone">IPhone</option>
                <option value="accessories">Accessories</option>
            </select>
            정렬
            <select id = "sort" >
                <option value="">기본</option>
                <option value="asc">낮은 금액순</option>
                <option value="desc">높은 금액순</option>
            </select>
            <button onclick="searchWithFilter()">검색하기</button>
        </div>

        <div id="productContainer">
        </div>
    </main>

<script>
    const pageSize = 4;
    let page = 1;
    let isLoading = false;

    function searchWithFilter() {
        const productContainer = document.getElementById('productContainer');
        productContainer.innerHTML = '';
        page = 1;

        fetchProductWithFilter()
    }

    function fetchProductWithFilter() {
        const searchInput = document.getElementById('search');
        const categorySelect = document.getElementById('category');
        const sortSelect = document.getElementById('sort');

        const keyword = searchInput.value.toLowerCase();
        const category = categorySelect.value.toLowerCase();
        const sortOption = sortSelect.value.toLowerCase();

        fetch('product.json')
            .then(response => response.json())
            .then(data => {

                let filteredProducts = data.products.filter(product =>
                    (product.title.toLowerCase().includes(keyword) || product.category.toLowerCase().includes(keyword)) && product.category.toLowerCase().includes(category)
                );

                if (sortOption === 'price-asc') {
                    filteredProducts.sort((a, b) => a.price - b.price);
                } else if (sortOption === 'price-desc') {
                    filteredProducts.sort((a, b) => b.price - a.price);
                }

                const products = filteredProducts;
                const startIndex = (page - 1) * pageSize;
                const endIndex = page * pageSize;

                if (startIndex < products.length) {
                    const thisPageProducts = products.slice(startIndex, endIndex);
                    renderProducts(thisPageProducts);
                }

                isLoading = false;

            })
            .catch(error => console.error('Error:', error));
    }

    function renderProducts(products) {
        const productContainer = document.getElementById('productContainer');

        products.forEach(product => {
            const productTile = createProductTile(product);
            productContainer.appendChild(productTile);
        });
    }

    function createProductTile(product) {
        const tile = document.createElement('div');
        tile.classList.add('product');

        const image = document.createElement('img');
        image.src = product.image;
        tile.appendChild(image);

        tile.addEventListener('click', () => {
            toggleProductInfo(tile, product);
        });

        return tile;
    }

    function toggleProductInfo(tile, product) {
        const description = document.createElement('div');
        description.classList.add('product-info');

        const title = document.createElement('h3');
        title.textContent = product.title;
        description.appendChild(title);

        const price = document.createElement('p');
        price.textContent = `${product.price}원`;
        description.appendChild(price);

        const descriptionText = document.createElement('p');
        descriptionText.textContent = product.description;
        description.appendChild(descriptionText);

        if (tile.classList.contains('active')) {
            tile.classList.remove('active');
            tile.removeChild(tile.lastChild);
        } else {
            const activeTile = document.querySelector('.product.active');
            if (activeTile) {
                activeTile.classList.remove('active');
                activeTile.removeChild(activeTile.lastChild);
            }

            tile.classList.add('active');
            tile.appendChild(description);
        }
    }

    function handleScroll() {
        if (isLoading) return;

        const { scrollTop, scrollHeight, clientHeight } = document.documentElement;

        if (scrollTop + clientHeight >= scrollHeight - 100) {
            isLoading = true;
            page++;
            fetchProductWithFilter();
        }
    }

    window.addEventListener('scroll', handleScroll);

    fetchProductWithFilter();
</script>
        
</body>
</html>