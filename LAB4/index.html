<!DOCTYPE html>
<html>

<head>
	<title>상품</title>
	<link rel="stylesheet" type="text/css" href="./main.css">
</head>
<body>
	<header>
		<div class="header-container">
			<h1>안녕하세요 마켓컬리입니다.</h1>
		</div>
        <div class="nav-container">
			<nav>
				<ul>
					<li><a href="./index.html">Home</a></li>
				</ul>
			</nav>
            <nav>
				<ul>
					<li><a href="./login.html">Login</a></li>
				</ul>
			</nav>
            <nav>
				<ul>
					<li><a href="./signup.html">Signup</a></li>
				</ul>
			</nav>
        </div>
	</header>
    <main>
        <div class="find">
            검색하기
            <input type="text" id = "search" class="searchInput" placeholder="검색하기">
            카테고리
            <select id = "category">
                <option value="">모두</option>
                <option value="mac">Mac</option>
                <option value="phone">IPhone</option>
                <option value="accessories">Accessories</option>
            </select>
            정렬
            <select id = "sort" >
                <option value="">기본</option>
                <option value="asc">낮은 금액순</option>
                <option value="desc">높은 금액순</option>
            </select>
            <button onclick="getProducts()">검색하기</button>
        </div>

        <div id="products">
            <!-- Products will be dynamically added here -->
        </div>
    </main>

<script>
    const pageSize = 4; // Number of products to load per page
    let page = 1; // Current page
    let isLoading = false; // Flag to track if products are being loaded

    function getProducts() {
        const productContainer = document.getElementById('products');
        productContainer.innerHTML = '';
        page = 1;
        
        try {
            fetch()
        } catch (err) {
            console.log(err)
        }
    }

    function fetch() {
        const search = document.getElementById('search');
        const category = document.getElementById('category');
        const sort = document.getElementById('sort');

        fetch('product.json')
            .then(response => response.json())
            .then(data => {

                let products = data.products.filter(product =>
                    (product.title.includes(keyword) || product.category.toLowerCase().includes(keyword)) && product.category.includes(category)
                );

                if (sort === 'price-asc') {
                    products.sort((a, b) => a.price - b.price);
                } else if (sort === 'price-desc') {
                    products.sort((a, b) => b.price - a.price);
                }


                const newProducts = products;
                const start = (page - 1) * pageSize;
                const end = page * pageSize;

                if (startIndex < newProducts.length) {
                    const thisPageProducts = newProducts.slice(startIndex, endIndex);
                    renderProducts(thisPageProducts);
                }

                isLoading = false;
            })
            .catch((err) => console.log(err));
    }


    function renderProducts(products) {
        const productInfos = document.getElementById('products');

        products.forEach(product => {
            const productTile = createProductTile(product);
            productInfos.appendChild(productTile);
        });
    }

    function createProductTile(product) {
        const tile = document.createElement('div');
        tile.classList.add('product');

        const image = document.createElement('img');
        image.src = product.image;
        tile.appendChild(image);

        tile.addEventListener('click', () => {
            toggleProductInfo(tile, product);
        });

        return tile;
    }

    function toggleProductInfo(tile, product) {
        const description = document.createElement('div');
        description.classList.add('product-info');

        const title = document.createElement('h3');
        title.textContent = product.title;
        description.appendChild(title);

        // const image = document.createElement('img');
        // image.src = product.image;
        // description.appendChild(image);

        const price = document.createElement('p');
        price.textContent = `$${product.price}`;
        description.appendChild(price);

        const descriptionText = document.createElement('p');
        descriptionText.textContent = product.description;
        description.appendChild(descriptionText);

        if (tile.classList.contains('active')) {
            tile.classList.remove('active');
            tile.removeChild(tile.lastChild);
        } else {
            const activeTile = document.querySelector('.product.active');
            if (activeTile) {
                activeTile.classList.remove('active');
                activeTile.removeChild(activeTile.lastChild);
            }

            tile.classList.add('active');
            tile.appendChild(description);
        }
    }

    function infiniteScroll() {
        if (isLoading) return;

        const { scrollTop, scrollHeight, clientHeight } = document.documentElement;

        if (scrollTop + clientHeight >= scrollHeight - 100) {
            isLoading = true;
            page += 1;
            fetch();
        }
    }

    window.addEventListener('scroll', infiniteScroll);

    fetch();
</script>
        
</body>
</html>